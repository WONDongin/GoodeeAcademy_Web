<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>주식차트게임</title>
        <style>
            @font-face {font-family: 'GmarketSansMedium'; src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_2001@1.1/GmarketSansMedium.woff') format('woff'); font-weight: normal;font-style: normal;}
            *{margin: 0; padding: 0; font-family: 'GmarketSansMedium'; font-weight: normal; font-size: 16px; color: #333; letter-spacing: -0.05rem; box-sizing: border-box;}
            #wrap{max-width: 1200px; width: 100%; margin: 0 auto; padding: 50px 0;}
            #main{position:relative; width: 100%; height: 800px; border: 2px solid #333; overflow: hidden; border-radius: 5px;}
            #main .cnt{position: absolute; left: 20px; top: 20px; width: 100px; height: 30px; padding: 5px; border: 1px solid #bebebe;}
            #nav{width: 100%; height: 50px; display: flex; align-items: center; justify-content: space-between;  margin-top: 30px;}
            #nav #stock{width: 150px; height: 100%; padding: 5px;border: 1px solid #bebebe;}
            #nav .start_btn{width: 150px; height: 100%; border: 1px solid #333; background-color: #f7f7f7; cursor: pointer;}
            #nav .start_btn:hover{background-color: #333; color: #fff;transition: 0.3s ease-in;}
            #nav .box{height: 100%; display: flex; align-items: baseline; gap: 10px; vertical-align:middle;}
            #nav .box input{width: 100px; height: 100%; padding: 5px; border: 1px solid #bebebe;} 

            #main span{display: block;border-radius: 10px;}
        </style>
    </head>
    <body>
        <div id="wrap">
            <div id="main">
                <select class="cnt">
                    <option value="1">5분 봉</option>
                    <option value="10">10분 봉</option>
                    <option value="30">30분 봉</option>
                </select>
            </div>

            <div id="nav">
                <select name="stock" id="stock" onchange="stock();">
                    <option value="10000">넥슨게임즈</option>
                    <option value="20000">위메이드</option>
                    <option value="30000">펄어비스</option>
                </select>

                <button class="start_btn" type="button" onclick="game();">시작</button>

                <div class="box"><span>시드 :</span><input type="text" id="seed" value="12000" readonly></div>
                <div class="box"><span>현재주가 :</span><input type="text" id="stockPrice" value="10000" readonly></div>
                <div class="box"><span>수익률 :</span><input type="text" id="totalRate" value="0.00%" readonly></div>
                <div class="box"><span>평가금액 :</span><input type="text" id="ea"  readonly></div>
            </div>
        </div>

        <script>
            let canvasWidth = 1200;
            let canvasHeight = 800;
            let charts = []; // 차트 객체 저장 배열
            let interval; // setInterval()을 사용할 때 인터벌 ID를 저장하는 변수
            let totalRate = 1 //  수익률 초기값 
            let stockPrice = parseFloat(document.getElementById("stockPrice").value); // 현재 주가
           
            let seed = parseFloat(document.getElementById("seed").value);
            // let seed = prompt("투자금액 : ");
            // document.getElementById("seed").value =  seed.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","); 
            let ea = seed // 초기 평가 금액 (투자금과 동일)
            document.getElementById("ea").value  = ea.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            // 주식 개수 (보유 주식 수) 계산
            let shares = seed / stockPrice; 

            // 상승/하락 여부 결정 (50% 확률)
            function getChangeAmount(chartY) {
                let isUp = Math.random() < 0.5; // 50% 확률로 상승/하락 결정
                let rate = Math.floor(Math.random() * 10) + 1; // 1~10% 랜덤 변화율
                let change = rate * 10; // Y축 변화(*10px)
            
                if (isUp) {
                    chartY -= change;  // 상승이면 Y값 감소 (위로 이동)
                    totalRate *= (1 + rate / 100); // 상승 → 수익률 증가
                    stockPrice *= (1 + rate / 100);  // 주가 증가
                } else {
                    chartY += change;  // 하락이면 Y값 증가 (아래로 이동)
                    totalRate *= (1 - rate / 100); // 하락 → 수익률 감소
                    stockPrice *= (1 - rate / 100);  // 주가 감소
                }
                ea = shares * stockPrice; 
            
                document.getElementById("totalRate").value = ((totalRate - 1) * 100).toFixed(2) + "%";
                document.getElementById("stockPrice").value = Math.round(stockPrice).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");;
                document.getElementById("ea").value = Math.round(ea).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            
                return { newY: Math.max(0, Math.min(canvasHeight - 100, chartY)), isUp }; 
            }

            // 차트 생성 함수
            function createChart(chartY) {
                let newChart = document.createElement("span");
                newChart.style.position = 'absolute';
                newChart.style.width = '20px';
                newChart.style.height = '100px';

                let x = charts.length * 40; // 차트의 x 좌표
                let { newY, isUp } = getChangeAmount(chartY);  // 변화량 계산
            
                newChart.style.backgroundColor = isUp ? '#ff3131' : '#7575ff'; // 상승(red), 하락(blue)
                newChart.style.transform = `translate(${x}px, ${newY}px)`; // span 네모 윗부분 기준 
            
                document.querySelector("#main").appendChild(newChart);
                return newY; // 생성된 차트의 y값 반환(다음 차트 기준)
            }

            // 게임 시작 함수
            function game() {
                let count = parseInt(document.querySelector(".cnt").value); // 생성할 차트 개수

                let totalCont =0;
                let createdCount = 0;
                // 초기 값 설정
                let chartY = charts.length > 0 ? charts[charts.length - 1] : 400; 
            
                interval = setInterval(() => {
                    if (createdCount < count) {
                        chartY = createChart(chartY); // 차트 생성 및 y값 갱신
                        charts.push(chartY); // 업데이트된 y 값 저장
                        createdCount++;
                    } 
                    
                    if(charts.length == 30){
                        setTimeout(() =>  {
                            clearInterval(interval); // 게임 루프 정지
                        }, 100);  
                        
                        if( confirm("게임종료,\n잔액:  " + Math.round(ea).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") + "원, 최종 수익률: " +  ((totalRate - 1) * 100).toFixed(2) + "%\n게임을 계속하시겠습니까?" )){
                             resetGame(); 
                         }else{
                             alert("안녕히가세요");
                         }
                    }
                }, 100);
            } 

            // 게임 재시작을 위한 초기화 함수
            function resetGame() {
                seed = Math.round(ea).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","); // 마지막 평가 금액을 새로운 seed로 설정
                totalRate = 1; // 수익률 초기화
                charts = []; // 차트 배열 초기화
                document.querySelectorAll("#main span").forEach(chart => chart.remove());
            
                // UI 업데이트
                document.getElementById("seed").value = seed.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                document.getElementById("ea").value = seed.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                document.getElementById("totalRate").value = "0.00%";

            }
                            
        </script>
    </body>
</html>